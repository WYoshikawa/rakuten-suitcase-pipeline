name: Daily Rakuten TOP100 Analysis
on:
  schedule:
    # æ¯æ—¥1å›ï¼ˆæ—¥æœ¬æ™‚é–“ æœ9æ™‚ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      analysis_mode:
        description: 'åˆ†æãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'full'
        type: choice
        options:
        - 'full'
        - 'basic'

# GitHub Actions ã«æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸
permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies (Lightweight)
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… è»½é‡åŒ–ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
      
      - name: Run TOP100 ranking data collection (Debug)
        env:
          APP_ID: ${{ secrets.APP_ID }}
        run: |
          echo "ğŸ¦ RASCAL TOP100 ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹"
          echo "ğŸ“Š APP_IDè¨­å®šç¢ºèª: ${APP_ID:0:10}..."
          echo "ğŸ“ å®Ÿè¡Œå‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
          ls -la
          
          echo "ğŸ Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œé–‹å§‹"
          python rakuten_rank_step1.py --pages 1 || echo "Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ"
          echo "ğŸ Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œçµ‚äº†"
          
          echo "ğŸ“ å®Ÿè¡Œå¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
          ls -la
          
          echo "ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«å°‚ç”¨æ¤œç´¢:"
          find . -name "*.csv" -type f -exec ls -la {} \; || echo "CSVãƒ•ã‚¡ã‚¤ãƒ«è¦‹ã¤ã‹ã‚‰ãš"
          
          echo "ğŸ“ rank_baseé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢:"
          find . -name "rank_base*" -type f -exec ls -la {} \; || echo "rank_baseãƒ•ã‚¡ã‚¤ãƒ«è¦‹ã¤ã‹ã‚‰ãš"
          
          echo "âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¹ãƒ†ãƒƒãƒ—å®Œäº†"
      
      - name: Run comprehensive analysis
        run: |
          echo "ğŸ” åˆ†ææ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾—ã®ã¿ï¼‰"
          echo "âœ… ã‚·ãƒ³ãƒ—ãƒ«åŒ–å®Œäº†"
      
      - name: Organize data files
        run: |
          echo "ğŸ“ ãƒ‡ãƒãƒƒã‚°: ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…å®¹"
          ls -la
          
          echo "ğŸ“ ãƒ‡ãƒãƒƒã‚°: å…¨CSVãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢"
          find . -name "*.csv" -type f || echo "CSVãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
          
          echo "ğŸ“ ãƒ‡ãƒãƒƒã‚°: rank_base_*ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œç´¢"
          ls -la rank_base_*.csv 2>/dev/null || echo "rank_base_*.csvãªã—"
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p data
          mkdir -p data/changes
          
          # æ—¥æœ¬æ™‚é–“ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å–å¾—
          DATE=$(TZ='Asia/Tokyo' date +%Y-%m-%d)
          TIME=$(TZ='Asia/Tokyo' date +%H-%M)
          
          echo "ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
          ls -la rank_base_*.csv *.json 2>/dev/null || echo "ä¸€éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
          
          # CSVãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆã‚ˆã‚ŠæŸ”è»Ÿãªæ¤œç´¢ï¼‰
          if ls *.csv 1> /dev/null 2>&1; then
            echo "âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«ç™ºè¦‹ã€ã‚³ãƒ”ãƒ¼é–‹å§‹"
            cp *.csv data/rank_base_${DATE}.csv
            cp *.csv data/rank_base_latest.csv
            echo "âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å®Œäº†"
          else
            echo "âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒå…¨ãè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # åˆ†æçµæœä¿å­˜ï¼ˆå‰Šé™¤ï¼‰
          echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ã¿ - åˆ†ææ©Ÿèƒ½ã¯å‰Šé™¤æ¸ˆã¿"
      
      - name: Validate data quality
        run: |
          echo "ğŸ” ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯ä¸­..."
          python -c "
          import pandas as pd
          import os
          
          if os.path.exists('data/rank_base_latest.csv'):
              df = pd.read_csv('data/rank_base_latest.csv')
              print(f'âœ… ãƒ‡ãƒ¼ã‚¿å“è³ªOK: {len(df)}ä»¶å–å¾—')
              print(f'ğŸ“Š ä¾¡æ ¼ç¯„å›²: Â¥{df[\"itemPrice\"].min():,} - Â¥{df[\"itemPrice\"].max():,}')
              
              # 30æ©Ÿèƒ½ãƒ•ãƒ©ã‚°ã®æ¤œè¨¼
              feature_cols = [col for col in df.columns if col.startswith(('has_', 'is_', 'for_', 'appeal_'))]
              print(f'ğŸ·ï¸ æ©Ÿèƒ½ãƒ•ãƒ©ã‚°: {len(feature_cols)}ç¨®é¡æ¤œå‡º')
              
              if len(df) < 50:
                  print('âš ï¸ è­¦å‘Š: ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ãŒå°‘ãªã™ãã¾ã™')
                  exit(1)
          else:
              print('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
              exit(1)
          "
      
      - name: Commit and push changes
        run: |
          git config --local user.email "rascal-top100@github.com"
          git config --local user.name "RASCAL TOP100 Bot"
          git add data/
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --staged --quiet; then
            echo "ğŸ“ å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
          else
            # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
            ITEMS_COUNT=$(python -c "
            import pandas as pd
            try:
                df = pd.read_csv('data/rank_base_latest.csv')
                print(len(df))
            except:
                print('?')
            ")
            
            git commit -m "ğŸ“Š Daily TOP100 data collection: ${ITEMS_COUNT}ä»¶å–å¾—å®Œäº† $(TZ='Asia/Tokyo' date +%Y-%m-%d_%H:%M)"
            git push https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            echo "âœ… ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
          fi
      
      - name: Analysis summary
        run: |
          echo ""
          echo "ğŸ¦============================================"
          echo "ğŸ¦ RASCAL TOP100 ãƒ‡ãƒ¼ã‚¿å–å¾—ç‰ˆ å®Ÿè¡Œå®Œäº†"
          echo "ğŸ¦============================================"
          echo "ğŸ“Š æ¥½å¤©ã‚¹ãƒ¼ãƒ„ã‚±ãƒ¼ã‚¹TOP100ãƒ‡ãƒ¼ã‚¿å–å¾—"
          echo "ğŸ·ï¸ 30ç¨®é¡æ©Ÿèƒ½ãƒ•ãƒ©ã‚°æ¤œå‡º"
          echo "ğŸ’¾ CSVãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜"
          echo "ğŸ¯ åˆ†ææ©Ÿèƒ½ãªã—ï¼ˆãƒ‡ãƒ¼ã‚¿å–å¾—ç‰¹åŒ–ï¼‰"
          echo "âš¡ è¶…é«˜é€Ÿãƒ»è¶…å®‰å®š"
          echo "ğŸ¦============================================"
