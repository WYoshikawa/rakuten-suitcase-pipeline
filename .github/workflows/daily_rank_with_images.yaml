name: Daily Rakuten Rank CSV with Image Analysis
on:
  schedule:
    # æ¯Žæ—¥1å›žï¼ˆæ—¥æœ¬æ™‚é–“ æœ9æ™‚ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      enable_images:
        description: 'ç”»åƒåˆ†æžã‚’æœ‰åŠ¹ã«ã™ã‚‹'
        required: false
        default: 'true'
        type: boolean
      pages:
        description: 'å–å¾—ãƒšãƒ¼ã‚¸æ•°'
        required: false
        default: '10'
        type: string

# GitHub Actions ã«æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸Ž
permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-glx libglib2.0-0 libsm6 libxext6 libxrender-dev libgomp1
      
      - name: Install Python dependencies
        run: |
          pip install -r requirements_with_images.txt
          pip install pandas numpy pillow opencv-python scikit-learn matplotlib
      
      - name: Run ranking script with images
        env:
          APP_ID: ${{ secrets.APP_ID }}
        run: |
          if [ "${{ github.event.inputs.enable_images }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            echo "ðŸŽ¨ ç”»åƒåˆ†æžæœ‰åŠ¹ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—é–‹å§‹"
            python rakuten_rank_step1.py --pages ${{ github.event.inputs.pages || '10' }} --with-images
          else
            echo "ðŸ“Š é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—é–‹å§‹"
            python rakuten_rank_step1.py --pages ${{ github.event.inputs.pages || '10' }}
          fi
      
      - name: Run image analysis (if images available)
        run: |
          echo "ðŸŽ¨ ç”»åƒåˆ†æžå®Ÿè¡Œä¸­..."
          python rascal_image_analyzer.py || echo "ç”»åƒåˆ†æžã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç”»åƒãƒ‡ãƒ¼ã‚¿ãªã—ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ï¼‰"
      
      - name: Organize CSV files
        run: |
          # dataãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
          mkdir -p data
          mkdir -p data/images
          
          # æ—¥æœ¬æ™‚é–“ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å–å¾—
          DATE=$(TZ='Asia/Tokyo' date +%Y-%m-%d)
          TIME=$(TZ='Asia/Tokyo' date +%H-%M)
          
          # ç”Ÿæˆã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
          echo "Generated CSV files:"
          ls -la rank_base_*.csv
          
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãã§ä¿å­˜
          if ls rank_base_*_with_images.csv 1> /dev/null 2>&1; then
            cp rank_base_*_with_images.csv data/rank_base_${DATE}_with_images.csv
            cp rank_base_*_with_images.csv data/rank_base_latest_with_images.csv
            echo "ç”»åƒä»˜ãCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ"
          elif ls rank_base_*.csv 1> /dev/null 2>&1; then
            cp rank_base_*.csv data/rank_base_${DATE}.csv
            cp rank_base_*.csv data/rank_base_latest.csv
            echo "é€šå¸¸CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ"
          else
            echo "No CSV files found!"
            exit 1
          fi
          
          # ç”»åƒåˆ†æžçµæžœãŒã‚ã‚Œã°ä¿å­˜
          if ls image_analysis_*.json 1> /dev/null 2>&1; then
            cp image_analysis_*.json data/images/
            echo "ç”»åƒåˆ†æžçµæžœã‚’ä¿å­˜ã—ã¾ã—ãŸ"
          fi
      
      - name: Analyze ranking changes
        run: |
          echo "ðŸ” ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¤‰åŒ–ã‚’åˆ†æžä¸­..."
          python analyze_changes_with_images.py || echo "å¤‰åŒ–åˆ†æžã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆåˆå›žå®Ÿè¡Œã¾ãŸã¯æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰"
      
      - name: Upload to Google Drive (Optional)
        env:
          GDRIVE_JSON: ${{ secrets.GDRIVE_JSON }}
          GDRIVE_FOLDER: ${{ secrets.GDRIVE_FOLDER }}
        run: |
          if [ -n "$GDRIVE_JSON" ] && [ -n "$GDRIVE_FOLDER" ]; then
            echo "ðŸ“¤ Google Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."
            python upload_to_drive_with_images.py || echo "Google Driveã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—"
          else
            echo "Google Driveè¨­å®šãªã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã®ã¿"
          fi
      
      - name: Generate analysis report
        run: |
          echo "ðŸ“Š RASCALåˆ†æžãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
          python generate_rascal_report.py || echo "ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
      
      - name: Commit and push changes
        run: |
          git config --local user.email "rascal@github.com"
          git config --local user.name "RASCAL 3.0 Bot"
          git add data/
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # ç”»åƒåˆ†æžãŒã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯
            if ls data/images/*.json 1> /dev/null 2>&1; then
              git commit -m "ðŸŽ¨ Daily ranking update with image analysis $(TZ='Asia/Tokyo' date +%Y-%m-%d)"
            else
              git commit -m "ðŸ“Š Daily ranking update $(TZ='Asia/Tokyo' date +%Y-%m-%d)"
            fi
            git push https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            echo "Data updated and pushed successfully"
          fi
