name: Daily Rakuten TOP100 Analysis
on:
  schedule:
    # æ¯æ—¥1å›ï¼ˆæ—¥æœ¬æ™‚é–“ æœ9æ™‚ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      analysis_mode:
        description: 'åˆ†æãƒ¢ãƒ¼ãƒ‰'
        required: false
        default: 'full'
        type: choice
        options:
        - 'full'
        - 'basic'

# GitHub Actions ã«æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸
permissions:
  contents: write

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies (Lightweight)
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… è»½é‡åŒ–ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"
      
      - name: Run TOP100 ranking data collection
        env:
          APP_ID: ${{ secrets.APP_ID }}
        run: |
          echo "ğŸ¦ RASCAL TOP100 ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹"
          python rakuten_rank_top100.py
          echo "âœ… TOP100ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†"
      
      - name: Run comprehensive analysis
        run: |
          echo "ğŸ” RASCAL TOP100 åŒ…æ‹¬åˆ†æå®Ÿè¡Œä¸­..."
          python rascal_top100_analyzer.py
          echo "âœ… åŒ…æ‹¬åˆ†æå®Œäº†"
      
      - name: Organize data files
        run: |
          # ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p data
          mkdir -p data/changes
          
          # æ—¥æœ¬æ™‚é–“ã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å–å¾—
          DATE=$(TZ='Asia/Tokyo' date +%Y-%m-%d)
          TIME=$(TZ='Asia/Tokyo' date +%H-%M)
          
          echo "ğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
          ls -la rank_base_*.csv *.json 2>/dev/null || echo "ä¸€éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
          
          # CSVãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
          if ls rank_base_*.csv 1> /dev/null 2>&1; then
            cp rank_base_*.csv data/rank_base_${DATE}.csv
            cp rank_base_*.csv data/rank_base_latest.csv
            echo "âœ… TOP100 CSVãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å®Œäº†"
          else
            echo "âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # åˆ†æçµæœä¿å­˜
          if ls data/changes/top100_analysis_*.json 1> /dev/null 2>&1; then
            echo "âœ… åˆ†æçµæœJSONä¿å­˜æ¸ˆã¿"
          elif ls top100_analysis_*.json 1> /dev/null 2>&1; then
            cp top100_analysis_*.json data/changes/
            echo "âœ… åˆ†æçµæœJSONä¿å­˜å®Œäº†"
          fi
      
      - name: Validate data quality
        run: |
          echo "ğŸ” ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯ä¸­..."
          python -c "
          import pandas as pd
          import os
          
          if os.path.exists('data/rank_base_latest.csv'):
              df = pd.read_csv('data/rank_base_latest.csv')
              print(f'âœ… ãƒ‡ãƒ¼ã‚¿å“è³ªOK: {len(df)}ä»¶å–å¾—')
              print(f'ğŸ“Š ä¾¡æ ¼ç¯„å›²: Â¥{df[\"itemPrice\"].min():,} - Â¥{df[\"itemPrice\"].max():,}')
              
              # 30æ©Ÿèƒ½ãƒ•ãƒ©ã‚°ã®æ¤œè¨¼
              feature_cols = [col for col in df.columns if col.startswith(('has_', 'is_', 'for_', 'appeal_'))]
              print(f'ğŸ·ï¸ æ©Ÿèƒ½ãƒ•ãƒ©ã‚°: {len(feature_cols)}ç¨®é¡æ¤œå‡º')
              
              if len(df) < 50:
                  print('âš ï¸ è­¦å‘Š: ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ãŒå°‘ãªã™ãã¾ã™')
                  exit(1)
          else:
              print('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')
              exit(1)
          "
      
      - name: Commit and push changes
        run: |
          git config --local user.email "rascal-top100@github.com"
          git config --local user.name "RASCAL TOP100 Bot"
          git add data/
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git diff --staged --quiet; then
            echo "ğŸ“ å¤‰æ›´ãªã— - ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
          else
            # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
            ITEMS_COUNT=$(python -c "
            import pandas as pd
            try:
                df = pd.read_csv('data/rank_base_latest.csv')
                print(len(df))
            except:
                print('?')
            ")
            
            git commit -m "ğŸ¦ Daily TOP100 analysis: ${ITEMS_COUNT}ä»¶åˆ†æå®Œäº† $(TZ='Asia/Tokyo' date +%Y-%m-%d_%H:%M)"
            git push https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            echo "âœ… ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"
          fi
      
      - name: Analysis summary
        run: |
          echo ""
          echo "ğŸ¦============================================"
          echo "ğŸ¦ RASCAL TOP100 è»½é‡åŒ–ç‰ˆ å®Ÿè¡Œå®Œäº†"
          echo "ğŸ¦============================================"
          echo "ğŸ“Š æ¥½å¤©ã‚¹ãƒ¼ãƒ„ã‚±ãƒ¼ã‚¹TOP100åˆ†æ"
          echo "ğŸ·ï¸ 30ç¨®é¡æ©Ÿèƒ½ãƒ•ãƒ©ã‚°æ¤œå‡º"
          echo "ğŸ’° å®Ÿå£²ä¾¡æ ¼æ¨å®šãƒ»å•†å“åå“è³ªè©•ä¾¡"
          echo "ğŸ“ˆ å¸‚å ´å¤‰åŒ–ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é‡è¦åº¦åˆ†æ"
          echo "ğŸ¯ ç”»åƒåˆ†æãªã—ï¼ˆè»½é‡åŒ–ç‰ˆï¼‰"
          echo "âš¡ é«˜é€Ÿãƒ»å®‰å®šãƒ»åŠ¹ç‡çš„"
          echo "ğŸ¦============================================"
