name: Daily Rakuten Rank with Image Analysis (Fixed)
on:
  schedule:
    # æ¯Žæ—¥1å›žï¼ˆæ—¥æœ¬æ™‚é–“ æœ9æ™‚ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      enable_images:
        description: 'ç”»åƒåˆ†æžã‚’æœ‰åŠ¹ã«ã™ã‚‹'
        required: false
        default: 'true'
        type: boolean
      pages:
        description: 'å–å¾—ãƒšãƒ¼ã‚¸æ•°'
        required: false
        default: '10'
        type: string

# GitHub Actions ã«æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸Ž
permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies (Fixed)
        run: |
          sudo apt-get update
          # ç”»åƒå‡¦ç†ç”¨ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ï¼ˆã‚¨ãƒ©ãƒ¼å›žé¿ç‰ˆï¼‰
          sudo apt-get install -y \
            libglib2.0-0 \
            libsm6 \
            libxext6 \
            libxrender-dev \
            libgomp1 \
            libgstreamer1.0-0 \
            libgstreamer-plugins-base1.0-0 \
            libxcb-xinerama0 \
            libfontconfig1-dev \
            libfreetype6-dev
          
          # OpenCVã®ä»£æ›¿: libgl1-mesa-glxã‚’é¿ã‘ã¦headlessç‰ˆã‚’ä½¿ç”¨
          sudo apt-get install -y python3-opencv || echo "OpenCV system package skipped"
      
      - name: Install Python dependencies (Image Analysis Ready)
        run: |
          pip install --upgrade pip
          
          # åŸºæœ¬ä¾å­˜é–¢ä¿‚
          pip install pandas requests requests-cache beautifulsoup4 tqdm python-dotenv
          
          # ç”»åƒåˆ†æžä¾å­˜é–¢ä¿‚ï¼ˆGitHub Actionså¯¾å¿œç‰ˆï¼‰
          pip install Pillow>=9.0.0
          pip install numpy>=1.21.0
          pip install matplotlib>=3.5.0
          pip install scikit-learn>=1.1.0
          pip install scipy>=1.8.0
          
          # OpenCV headlessç‰ˆï¼ˆGUIä¾å­˜ãªã—ï¼‰
          pip install opencv-python-headless>=4.7.0
          
          # è‰²å½©åˆ†æž
          pip install colorthief>=0.2.1
          pip install webcolors>=1.12
          
          # Google Driveé€£æºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          pip install google-auth==2.23.4 google-auth-oauthlib==1.1.0 google-auth-httplib2==0.1.1 google-api-python-client==2.108.0
      
      - name: Run ranking script with images
        env:
          APP_ID: ${{ secrets.APP_ID }}
        run: |
          if [ "${{ github.event.inputs.enable_images }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            echo "ðŸŽ¨ ç”»åƒåˆ†æžæœ‰åŠ¹ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—é–‹å§‹"
            python rakuten_rank_step1.py --pages ${{ github.event.inputs.pages || '10' }} --with-images
          else
            echo "ðŸ“Š é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—é–‹å§‹"
            python rakuten_rank_step1.py --pages ${{ github.event.inputs.pages || '10' }}
          fi
      
      - name: Run image analysis (GitHub Actions optimized)
        run: |
          echo "ðŸŽ¨ ç”»åƒåˆ†æžå®Ÿè¡Œä¸­..."
          python rascal_image_analyzer_headless.py || echo "ç”»åƒåˆ†æžã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç”»åƒãƒ‡ãƒ¼ã‚¿ãªã—ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ï¼‰"
      
      - name: Organize files
        run: |
          mkdir -p data
          mkdir -p data/images
          
          DATE=$(TZ='Asia/Tokyo' date +%Y-%m-%d)
          
          echo "ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèª:"
          ls -la rank_base_*.csv image_analysis_*.json 2>/dev/null || echo "ä¸€éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
          
          # CSVãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
          if ls rank_base_*_with_images.csv 1> /dev/null 2>&1; then
            cp rank_base_*_with_images.csv data/rank_base_${DATE}_with_images.csv
            cp rank_base_*_with_images.csv data/rank_base_latest_with_images.csv
            echo "âœ… ç”»åƒä»˜ãCSVãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜"
          elif ls rank_base_*.csv 1> /dev/null 2>&1; then
            cp rank_base_*.csv data/rank_base_${DATE}.csv
            cp rank_base_*.csv data/rank_base_latest.csv
            echo "âœ… é€šå¸¸CSVãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜"
          fi
          
          # ç”»åƒåˆ†æžçµæžœä¿å­˜
          if ls image_analysis_*.json 1> /dev/null 2>&1; then
            cp image_analysis_*.json data/images/
            echo "âœ… ç”»åƒåˆ†æžçµæžœä¿å­˜"
          fi
      
      - name: Analyze changes
        run: |
          echo "ðŸ” ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¤‰åŒ–åˆ†æžä¸­..."
          python analyze_changes.py || echo "å¤‰åŒ–åˆ†æžã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆåˆå›žå®Ÿè¡Œã¾ãŸã¯æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰"
      
      - name: Commit and push changes
        run: |
          git config --local user.email "rascal@github.com"
          git config --local user.name "RASCAL Bot"
          git add data/
          
          if git diff --staged --quiet; then
            echo "å¤‰æ›´ãªã—"
          else
            if ls data/images/*.json 1> /dev/null 2>&1; then
              git commit -m "ðŸŽ¨ Daily ranking update with image analysis $(TZ='Asia/Tokyo' date +%Y-%m-%d)"
            else
              git commit -m "ðŸ“Š Daily ranking update $(TZ='Asia/Tokyo' date +%Y-%m-%d)"
            fi
            git push https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            echo "âœ… ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†"
          fi
